# Тестовое задание на позицию Junior PHP разработчик

[![PHP CI](https://github.com/behindthep/test-assignment-1/actions/workflows/workflow.yml/badge.svg)](https://github.com/behindthep/test-assignment-1/actions/workflows/workflow.yml)

## Задание:
Необходимо получить все данные по описанным эндпоинтам и сохранить в БД MySQL, которую развернуть на бесплатном хостинге (например, SpaceWeb (https://cp.sweb.ru)).
**Тестовое API** для получения данных: https://github.com//cy322666/wb-api/blob/master/README.md
**Postman Коллекция** с примерами запросов к API: https://www.postman.com/cy322666/app-api-test/overview

---

### Подготовка окружения

1) Сгенерировал модели и миграции php artisan make:model Stock --migration
2) Создал MySQL 8 базу данных на хосте spaceweb
3) Настроил подключение к БД в .env файле

### Создание Базы

1) Изучил структуры данных JSON ответов, которые отдают endpoint'ы на Postman
2) Заполнил миграции необходимыми полями и накатил их

### Получение данных

#### 1) Создал Команду php artisan import:api-data, которая:

Кратко: используется для начальной инициализации и добавления в очередь задач на импорт данных для необходимых таблиц.

- Перебираются таблицы: sales, orders, stocks, incomes и для каждой:
    - Проверяется, существует ли таблица в базе.
    - Проверяется, есть ли в таблице уже данные — если есть, импорт пропускается.

    - Определяются даты для импорта (dateFrom и dateTo).
        - *Для таблицы складов stocks берется только текущий день.*
        - Для остальных — с 1970-01-01 по сегодня.

    - Создаётся и ставится в очередь задача на импорт данных из API для этой таблицы и заданного периода, начиная со страницы 1.

#### 2) Создал Воркер для выполнения импорта.

Кратко: воркер берёт из очереди задачи на имппорт данных и выполняет их, уже самостоятельно создавая новые задачи для следующих страниц.

- Делается HTTP-запрос к внешнему API на получение данных с параметрами:
    - endpoint — имя таблицы (например, sales).
    - dateFrom, dateTo — даты для фильтрации.
    - page — номер страницы (начинается с 1).
    - limit — количество записей на страницу (500).
    - key — API ключ.

- Если данные есть, то они:
    - вставляются в соответствующую таблицу базы.
    - из метаданных ответа берётся общее количество страниц (last_page).
    - если текущая страница меньше last_page, создаётся новая задача на следующую страницу (page + 1) и ставится в очередь.

Благодаря рекурсивной постановке задач на следующие страницы, данные подгружаются постранично.

#### 3) Подключил Laravel Horizon для запуска Воркера и отслеживания процесса выполнения задач.
